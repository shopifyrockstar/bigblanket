{% capture cart_json %}{{ cart | json }}{% endcapture %}{% capture items_orig %}"items":{{ cart.items | json }}{% endcapture %}{% assign cart_json = cart_json | replace: items_orig, '***ITEMS***' %}{% capture d_applications_json %}"cart_level_discount_applications":[{{ cart_json | split: ',"cart_level_discount_applications":[' | last | split: ']' | first }}]{% endcapture %}{% assign cart_json = cart_json | replace: d_applications_json, '***DISCOUNT-APPLICATIONS***' %}{% capture original_price_orig %}"original_total_price":{{ cart.original_total_price }}{% endcapture %}{% capture original_price_new %}"original_total_price":{% render 'dla_dm_cart_original_total' %}{% endcapture %}{% assign cart_json = cart_json | replace: original_price_orig, original_price_new %}{% capture items_price_orig %}"items_subtotal_price":{{ cart.items_subtotal_price }}{% endcapture %}{% capture items_price_new %}"items_subtotal_price":{% render 'dla_dm_cart_items_total' %}{% endcapture %}{% assign cart_json = cart_json | replace: items_price_orig, items_price_new %}{% capture total_price_orig %}"total_price":{{ cart.total_price }}{% endcapture %}{% capture total_price_new %}"total_price":{% render 'dla_dm_cart_final_total' %}{% endcapture %}{% assign cart_json = cart_json | replace: total_price_orig, total_price_new %}{% capture discount_price_orig %}"total_discount":{{ cart.total_discount }}{% endcapture %}{% capture discount_price_new %}"total_discount":{% render 'dla_dm_cart_discount' %}{% endcapture %}{% assign cart_json = cart_json | replace: discount_price_orig, discount_price_new %}{% capture items_new %}"items":[{% for line_item in cart.items %}{% render 'dla_dm_json_line_item', dm_orig_line_item: line_item %}{% unless forloop.last == true %},{% endunless %}{% endfor %}]{% endcapture %}{% assign cart_json = cart_json | replace: '***ITEMS***', items_new %}{% capture json_sep %}{% raw %}},{{% endraw %}{% endcapture %}{% assign d_applications_json_parts = d_applications_json | split: json_sep %}{% capture d_applications_json_new %}{% for json_part in d_applications_json_parts %}{% assign json_part_new = json_part %}{% for discount_application in cart.cart_level_discount_applications %}{% capture value %}"value":"{{ discount_application.value }}"{% endcapture %}{% capture type %}"value_type":"{{ discount_application.value_type }}"{% endcapture %}{% capture amount %}"total_allocated_amount":{{ discount_application.total_allocated_amount }}{% endcapture %}{% assign check_value = json_part | split: value %}{% assign check_type = json_part | split: type %}{% assign check_amount = json_part | split: amount %}{% if check_value.size == 2 and check_type.size == 2 and check_amount.size == 2 %}{% capture amount_new %}"total_allocated_amount":{% render 'dla_dm_cart_discount_application', dm_orig_discount_application: discount_application %}{% endcapture %}{% assign json_part_new = json_part_new | replace: amount, amount_new %}{% break %}{% endif %}{% endfor %}{{ json_part_new }}{% unless forloop.last == true %}{{ json_sep }}{% endunless %}{% endfor %}{% endcapture %}{% assign cart_json = cart_json | replace: '***DISCOUNT-APPLICATIONS***', d_applications_json_new %}{{ cart_json }}