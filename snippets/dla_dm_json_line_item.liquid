{% capture item_json %}{{ dm_orig_line_item | json }}{% endcapture %}{% capture discounts_json %}"discounts":[{{ item_json | split: ',"discounts":[' | last | split: ']' | first }}]{% endcapture %}{% assign item_json = item_json | replace: discounts_json, '***DISCOUNTS***' %}{% capture d_allocations_json %}"line_level_discount_allocations":[{{ item_json | split: ',"line_level_discount_allocations":[' | last | split: ']' | first }}]{% endcapture %}{% assign item_json = item_json | replace: d_allocations_json, '***DISCOUNT-ALLOCATIONS***' %}{% capture original_price_0 %}"original_price":{{ dm_orig_line_item.original_price }}{% endcapture %}{% capture original_price_1 %}"original_price":{% render 'dla_dm_cart_line_original_individual', dm_rounding: true, dm_orig_line_item: dm_orig_line_item %}{% endcapture %}{% assign item_json = item_json | replace: original_price_0, original_price_1 %}{% capture price_0 %}"price":{{ dm_orig_line_item.original_price }}{% endcapture %}{% capture price_1 %}"price":{% render 'dla_dm_cart_line_original_individual', dm_rounding: true, dm_orig_line_item: dm_orig_line_item %}{% endcapture %}{% assign item_json = item_json | replace: price_0, price_1 %}{% capture original_line_price_0 %}"original_line_price":{{ dm_orig_line_item.original_line_price }}{% endcapture %}{% capture original_line_price_1 %}"original_line_price":{% render 'dla_dm_cart_line_original_total', dm_orig_line_item: dm_orig_line_item %}{% endcapture %}{% assign item_json = item_json | replace: original_line_price_0, original_line_price_1 %}{% capture final_price_0 %}"final_price":{{ dm_orig_line_item.final_price }}{% endcapture %}{% capture final_price_1 %}"final_price":{% render 'dla_dm_cart_line_final_individual', dm_rounding: true, dm_orig_line_item: dm_orig_line_item %}{% endcapture %}{% assign item_json = item_json | replace: final_price_0, final_price_1 %}{% capture final_line_price_0 %}"final_line_price":{{ dm_orig_line_item.final_line_price }}{% endcapture %}{% capture final_line_price_1 %}"final_line_price":{% render 'dla_dm_cart_line_final_total', dm_orig_line_item: dm_orig_line_item %}{% endcapture %}{% assign item_json = item_json | replace: final_line_price_0, final_line_price_1 %}{% capture discounted_price_0 %}"discounted_price":{{ dm_orig_line_item.price }}{% endcapture %}{% capture discounted_price_1 %}"discounted_price":{% render 'dla_dm_cart_line_final_individual_old', dm_rounding: true, dm_orig_line_item: dm_orig_line_item %}{% endcapture %}{% assign item_json = item_json | replace: discounted_price_0, discounted_price_1 %}{% capture line_price_0 %}"line_price":{{ dm_orig_line_item.line_price }}{% endcapture %}{% capture line_price_1 %}"line_price":{% render 'dla_dm_cart_line_final_total_old', dm_orig_line_item: dm_orig_line_item %}{% endcapture %}{% assign item_json = item_json | replace: line_price_0, line_price_1 %}{% capture json_sep %}{% raw %}},{{% endraw %}{% endcapture %}{% assign discounts_json_parts = discounts_json | split: json_sep %}{% capture discounts_json_new %}{% for json_part in discounts_json_parts %}{% assign json_part_new = json_part %}{% for discount_allocation in dm_orig_line_item.discount_allocations %}{% capture amount %}"amount":{{ discount_allocation.amount }}{% endcapture %}{% capture title %}"title":"{{ discount_allocation.discount_application.title }}"{% endcapture %}{% assign check_amount = json_part | split: amount %}{% assign check_title = json_part | split: title %}{% if check_amount.size == 2 and check_title.size == 2 %}{% capture amount_new %}"amount":{% render 'dla_dm_cart_line_discount_allocation', dm_orig_line_item: dm_orig_line_item, dm_orig_discount_allocation: discount_allocation %}{% endcapture %}{% assign json_part_new = json_part_new | replace: amount, amount_new %}{% break %}{% endif %}{% endfor %}{{ json_part_new }}{% unless forloop.last == true %}{{ json_sep }}{% endunless %}{% endfor %}{% endcapture %}{% assign item_json = item_json | replace: '***DISCOUNTS***', discounts_json_new %}{% assign d_allocations_json_parts = d_allocations_json | split: json_sep %}{% capture d_allocations_json_new %}{% for json_part in d_allocations_json_parts %}{% assign json_part_new = json_part %}{% for discount_allocation in dm_orig_line_item.line_level_discount_allocations %}{% capture amount %}"amount":{{ discount_allocation.amount }}{% endcapture %}{% capture value %}"value":"{{ discount_allocation.discount_application.value }}"{% endcapture %}{% capture type %}"value_type":"{{ discount_allocation.discount_application.value_type }}"{% endcapture %}{% capture selection %}"target_selection":"{{ discount_allocation.discount_application.target_selection }}"{% endcapture %}{% capture allocated %}"total_allocated_amount":{{ discount_allocation.discount_application.total_allocated_amount }}{% endcapture %}{% assign check_amount = json_part | split: amount %}{% assign check_value = json_part | split: value %}{% assign check_type = json_part | split: type %}{% assign check_selection = json_part | split: selection %}{% assign check_allocated = json_part | split: allocated %}{% if check_amount.size == 2 and check_value.size == 2 and check_type.size == 2 and check_selection.size == 2 and check_allocated.size == 2 %}{% capture amount_new %}"amount":{% render 'dla_dm_cart_line_discount_allocation', dm_orig_line_item: dm_orig_line_item, dm_orig_discount_allocation: discount_allocation %}{% endcapture %}{% capture allocated_new %}"total_allocated_amount":{% render 'dla_dm_cart_line_discount_application', dm_orig_line_item: dm_orig_line_item, dm_orig_discount_allocation: discount_allocation %}{% endcapture %}{% assign json_part_new = json_part_new | replace: amount, amount_new %}{% assign json_part_new = json_part_new | replace: allocated, allocated_new %}{% break %}{% endif %}{% endfor %}{{ json_part_new }}{% unless forloop.last == true %}{{ json_sep }}{% endunless %}{% endfor %}{% endcapture %}{% assign item_json = item_json | replace: '***DISCOUNT-ALLOCATIONS***', d_allocations_json_new %}{{ item_json }}