{% capture dm_discount_string %}{% render 'dla_dm_discount_settings', dm_orig_product: dm_orig_product, dm_orig_variant: dm_orig_variant %}{% endcapture %}{% if dm_discount_string == '' %}{{ dm_orig_variant.price }},{{ dm_orig_variant.compare_at_price | json }}{% else %}{% assign dm_original_price = dm_orig_variant.price | times: 0.1 | times: 10 %}{% assign dm_discounted_price = dm_original_price %}{% if dm_orig_variant.compare_at_price %}{% assign dm_original_compare = dm_orig_variant.compare_at_price | times: 0.1 | times: 10 %}{% assign dm_updated_compare = dm_original_compare %}{% else %}{% assign dm_original_compare = null %}{% assign dm_updated_compare = null %}{% endif %}{% assign dm_discount_array = dm_discount_string | split: ';' %}{% assign dm_discount_value = dm_discount_array[0] | abs %}{% assign dm_discount_value_type = dm_discount_array[1] %}{% assign dm_discount_override_cents = dm_discount_array[2] %}{% assign dm_discount_override_cents_to = dm_discount_array[3] | abs %}{% assign dm_discount_override_to_nearest = dm_discount_array[4] %}{% assign dm_discount_compare_price_mode = dm_discount_array[5] %}{% if dm_discount_override_cents == 'true' %}{% assign dm_discount_override_cents = true %}{% else %}{% assign dm_discount_override_cents = false %}{% endif %}{% if dm_discount_override_to_nearest == 'true' %}{% assign dm_discount_override_to_nearest = true %}{% else %}{% assign dm_discount_override_to_nearest = false %}{% endif %}{% if dm_discount_value_type != 'percentage' and shop.currency != cart.currency.iso_code %}{% capture dm_discount_value %}{% render 'dla_dm_currency_converter', dm_price_in_shop_currency: dm_discount_value %}{% endcapture %}{% assign dm_discount_value = dm_discount_value | abs %}{% endif %}{% if dm_discount_value_type == 'percentage' %}{% assign discount_value = dm_discounted_price | times: dm_discount_value | divided_by: 100 %}{% assign dm_discounted_price = dm_discounted_price | minus: discount_value %}{% endif %}{% if dm_discount_value_type == 'fixed' %}{% assign discount_value = dm_discount_value | times: 100 %}{% assign dm_discounted_price = dm_discounted_price | minus: discount_value %}{% endif %}{% if dm_discount_value_type == 'set-new' %}{% assign dm_discounted_price = dm_discount_value | times: 100 %}{% endif %}{% if dm_discounted_price < 0 %}{% assign dm_discounted_price = 0 %}{% endif %}{% if shop.currency != cart.currency.iso_code %}{% assign dm_discount_override_cents = true %}{% assign dm_discount_override_to_nearest = false %}{% assign dm_discount_override_cents_to = dm_original_price | divided_by: 100 | modulo: 1 | times: 100 | round %}{% endif %}{% if dm_discount_override_cents %}{% assign dm_discounted_price = dm_discounted_price | divided_by: 100 %}{% assign cents = dm_discount_override_cents_to | times: 0.1 | times: 10 | divided_by: 100 %}{% if dm_discount_override_to_nearest %}{% assign offset = 1 | minus: cents %}{% assign dm_discounted_price = dm_discounted_price | plus: offset | round | minus: offset %}{% else %}{% assign dm_discounted_price = dm_discounted_price | minus: cents | ceil | plus: cents %}{% endif %}{% assign dm_discounted_price = dm_discounted_price | times: 100 %}{% endif %}{% if dm_discounted_price != dm_original_price %}{% if dm_original_compare %}{% if dm_discount_compare_price_mode == 'set-old-price' %}{% assign dm_updated_compare = dm_original_price %}{% endif %}{% if dm_discount_compare_price_mode == 'use-discount' %}{% if dm_discount_value_type == 'percentage' %}{% assign discount_value = dm_updated_compare | times: dm_discount_value | divided_by: 100 %}{% assign dm_updated_compare = dm_updated_compare | minus: discount_value %}{% endif %}{% if dm_discount_value_type == 'fixed' %}{% assign discount_value = dm_discount_value | times: 100 %}{% assign dm_updated_compare = dm_updated_compare | minus: discount_value %}{% endif %}{% if dm_discount_value_type == 'set-new' %}{% assign dm_updated_compare = dm_discount_value | times: 100 %}{% endif %}{% if dm_updated_compare < 0 %}{% assign dm_updated_compare = 0 %}{% endif %}{% if shop.currency != cart.currency.iso_code %}{% assign dm_discount_override_cents = true %}{% assign dm_discount_override_to_nearest = false %}{% assign dm_discount_override_cents_to = dm_original_compare | divided_by: 100 | modulo: 1 | times: 100 | round %}{% endif %}{% if dm_discount_override_cents %}{% assign dm_updated_compare = dm_updated_compare | divided_by: 100 %}{% assign cents = dm_discount_override_cents_to | times: 0.1 | times: 10 | divided_by: 100 %}{% if dm_discount_override_to_nearest %}{% assign offset = 1 | minus: cents %}{% assign dm_updated_compare = dm_updated_compare | plus: offset | round | minus: offset %}{% else %}{% assign dm_updated_compare = dm_updated_compare | minus: cents | ceil | plus: cents %}{% endif %}{% assign dm_updated_compare = dm_updated_compare | times: 100 %}{% endif %}{% endif %}{% else %}{% assign dm_updated_compare = dm_original_price %}{% endif %}{% endif %}{{ dm_discounted_price }},{{ dm_updated_compare | json }}{% endif %}